module Mlabs.Extract.WbeClient (test, requestBalance) where

-- import PlutusTx.Prelude hiding (mempty, (<>), mconcat)
import Prelude (mempty, (<>), mconcat)
import Prelude as Hask

import GHC.Generics ( Generic )
import Control.Monad.IO.Class
import Network.HTTP.Req

import Data.Aeson
import Data.Aeson.Lens
import Data.Text ( Text )

import Mlabs.Extract.TxRead

data ReqRedeemer = 
  ReqRedeemer
  deriving stock (Hask.Show, Generic)
  deriving anyclass (ToJSON, FromJSON)
  
data ReqInput =
  ReqInput
  deriving stock (Hask.Show, Generic)
  deriving anyclass (ToJSON, FromJSON)

type WalletId = Text

data BalanceRequest = BalanceRequest
  { transaction :: !Text 
  , inputs :: [ReqInput]
  , redeemers :: [ReqRedeemer]

  }
  deriving stock (Hask.Show, Generic)
  deriving anyclass (ToJSON, FromJSON)

data WbeCfg = WbeCfg
  { url :: Text
  }

requestBalance :: WbeCfg -> WalletId -> BalanceRequest -> Hask.IO ()
requestBalance WbeCfg{..} walletId reqBody = runReq defaultHttpConfig $ do
  r <-
    req
      POST
      (http "localhost" /: "v2"/: "wallets" /: walletId /: "transactions-balance")
      (ReqBodyJson reqBody) 
      lbsResponse   
      (port 8090)
  case decode $ responseBody r of
    Nothing -> liftIO $ putStrLn "failed to read  balance reposnse"
    Just wbeTx ->  liftIO $ print $ parseTx wbeTx

  -- liftIO $ Hask.print (responseBody r :: Value)

testRequest :: BalanceRequest
testRequest = 
  BalanceRequest
    "84a60081825820686106f51262efb810d99311d3bbe478ba5abb92b5be2e1f9488d56622caf6f4020d80018183581d704ea976fd940616cba7c01514e9bb4026cff5a087987d5595f3ad0aa58200a1581c8b7825c6ea0784322202af9f7d30f0f5fd94d85862352bd3998770a5a15820f8bbaa59790d202a879995c38e53d59883c520ae335b95fca9ee2cd24a874958015820d2f86a6f02691735fef36514963f343ca7aed0124c4a0dcef51ca64d1d820d8702000e8009a1581c8b7825c6ea0784322202af9f7d30f0f5fd94d85862352bd3998770a5a15820f8bbaa59790d202a879995c38e53d59883c520ae335b95fca9ee2cd24a87495801a30381590f0f590f0c010000333323322333222323322332233223232323322333222323332223332223333333322222222333332222233332222332233223322333222332233223322332233223322323322323233223232323233332222323232323232323232323232323232222223232533530623322323530620082225335306853353068333553023120013502150242330683530310012200200d35302e5004222222222200a106a13357389201115554584f206e6f7420636f6e73756d656400069153353068533530685335350593232335001505c505d1223335505b2235355039002223335505f223535503d0022253353073333573466e1c0052000075074100313300a33355506800600200100300300100100335302e50042222222222007106922135355505e00222253353505e00415335306d333573466e3cc0b402800c1bc1b854cd4c1b4cc0b001c0084ccd5cd19b87001480081bc1b841b841b88841c041a84cd5ce24811357726f6e6720616d6f756e74206d696e74656400069153353068533530683335530231200135021502423530330012225335306c35303a0032235303c0132232335305e0052335305f004253353073333573466e3c0080041d41d05400c41d081d08cd4c17c01081d094cd4c1ccccd5cd19b8f00200107507415003107415335350400032153353504100221335305c0022335305d00223353061002233530620022330350020012077233530620022077233035002001222077222335305f004207722253353078333573466e1c01800c1e81e454cd4c1e0ccd5cd19b8700500207a07913306e00400110791079107215335350400012107210721323335530281200135065506423535503a0012233355302b1200135068506723535503d00122333535502800123306a4800000488cc1ac0080048cc1a80052000001335530271200123535503a00122335503d002333535502500123355302b1200123535503e00122335504100235502c0010012233355502503100200123355302b1200123535503e00122335504100235502a00100133355502002c00300133505e3355039302c00933505e335503900648009417d417c41b4d4c0b94010888888888802441a84cd5ce24915446f6573206e6f742070617920746f207374617465000691533530683306700c001106a13357389201314e465469642054784f757452656620616e64206d696e74696e672054784f75745265662061726520646966666572656e74000691069106910691353028001220023333573466e1cd55ce9baa0044800080948d4098d4c090cd5ce2490350543100025499263333573466e1cd55cea8012400046605064646464646464646464646666ae68cdc39aab9d500a480008cccccccccc0d8cd40548c8c8cccd5cd19b8735573aa004900011981e180f1aba15002301a357426ae8940088d40d8d4c0d0cd5ce249035054310003549926135573ca00226ea8004d5d0a80519a80a80b1aba150093335501875ca02e6ae854020ccd54061d7280b9aba1500733501501e35742a00c66a02a66aa04203eeb4d5d0a8029919191999ab9a3370e6aae754009200023350473232323333573466e1cd55cea80124000466a09e66a048eb4d5d0a80118129aba135744a00446a0746a607066ae712401035054310003949926135573ca00226ea8004d5d0a8011919191999ab9a3370e6aae7540092000233504d33502475a6ae854008c094d5d09aba2500223503a3530383357389201035054310003949926135573ca00226ea8004d5d09aba250022350363530343357389201035054310003549926135573ca00226ea8004d5d0a80219a80abae35742a00666a02a66aa042eb88004d5d0a801180d9aba135744a00446a0646a606066ae71241035054310003149926135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a8011919191999ab9a3370ea002900311824180b1aba135573ca00646666ae68cdc3a801240084608e60306ae84d55cf280211999ab9a3370ea006900111823980a1aba135573ca00a46666ae68cdc3a80224000460946eb8d5d09aab9e500623502d35302b3357389201035054310002c49926499264984d55cea80089baa001357426ae8940088d4098d4c090cd5ce2490350543100025499261024135025353023335738920103505435000244984d55cf280089baa0011232230023758002640026aa0c0446666aae7c004941448cd4140c010d5d080118019aba200201f23232323333573466e1cd55cea801a400046660526464646666ae68cdc39aab9d5002480008cc0c4c04cd5d0a80119a8060091aba135744a00446a04a6a604666ae712401035054310002449926135573ca00226ea8004d5d0a801999aa803bae500635742a00466a010eb8d5d09aba2500223502135301f335738921035054310002049926135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5417888c8cccd55cf80112828119a82799aa81518031aab9d5002300535573ca00460086ae8800c0784d5d080089119191999ab9a3370ea002900011a81698029aba135573ca00646666ae68cdc3a801240044a05a46a03e6a603a66ae712401035054310001e499264984d55cea80089baa001232323333573466e1cd55cea801240004660ba600a6ae854008dd69aba135744a00446a0386a603466ae71241035054310001b49926135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088d4068d4c060cd5ce2490350543100019499261375400224464646666ae68cdc3a800a40084a06446666ae68cdc3a8012400446a06a600c6ae84d55cf280211999ab9a3370ea00690001281a91a80e9a980d99ab9c4901035054310001c4992649926135573aa00226ea80048c8cccd5cd19b87500148008815c8cccd5cd19b87500248000815c8d4064d4c05ccd5ce2490350543100018499264984d55ce9baa001232323232323333573466e1d4005200c203d23333573466e1d4009200a203f23333573466e1d400d200823303d375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c46607e6eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc110c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c118c034d5d09aab9e500b23333573466e1d401d200023045300e357426aae7940308d4084d4c07ccd5ce2481035054310002049926499264992649926135573aa00826aae79400c4d55cf280109aab9e5001137540024646464646666ae68cdc3a800a400446660826eb4d5d0a8021bad35742a0066eb4d5d09aba2500323333573466e1d40092000230433008357426aae7940188d4068d4c060cd5ce24810350543100019499264984d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c104dd71aba135573ca00646666ae68cdc3a80124000460866eb8d5d09aab9e500423501735301533573892010350543100016499264984d55cea80089baa0011122232323333573466e1cd55cea80124000466aa042600c6ae854008c014d5d09aba25002235017353015335738921035054310001649926135573ca00226ea8004444888ccd54c010480054108cd54c028480048d4d5407400488cd54080008d5402c004ccd54c0104800488d4d54078008894cd4c150ccd54c03c48004d403540408d4d5408400488cc028008014018400c4cd411801000d410c004cd54c028480048d4d5407400488c8cd5408400cc004014c8004d54160894cd4d41180044d5402c00c884d4d5408c008894cd4c164cc0300080204cd5404001c0044c01800c008c8004d5414488448894cd4d41080044008884cc014008ccd54c01c480040140100044484888c00c01044884888cc0080140104484888c00401044800448cd410888ccd4d401c00c88008008004d4d401400488004c8004d5412c8844894cd4d40ec004540f4884cd40f8c010008cd54c01848004010004c8004d5412888448894cd4d40ec0044d4d410c00c88004884ccd4d411401488008c010008ccd54c01c480040140100044cd4008894cd4c1180084120400411448848cc00400c0084800488ccd5cd19b8f00200104504423530050012253333530200012135007353005335738921024c68000064988400484d401cd4c014cd5ce249024c680000649884d401cd4c014cd5ce2481024c68000064984800480044988848cc00400c0088004888888888848cccccccccc00402c02802402001c01801401000c00880048848cc00400c008800488848ccc00401000c0088004448848cc00400c0084480048848cc00400c008800448488c00800c44880044800448848cc00400c0084800448848cc00400c0084800448848cc00400c00848004484888c00c010448880084488800448004848888c010014848888c00c014848888c008014848888c0040148004848888888c01c0208848888888cc018024020848888888c014020488888880104888888800c8848888888cc0080240208848888888cc00402402080048488c00800c888488ccc00401401000c80048488c00800c8488c00400c80044488c8004c8004d5405c894cd4d4014004400c884cc018008c0100044488008488488cc00401000c4800444488848ccc00401000c008444800488ccd5cd19b8700200100e00d1335005225335300b0021001100c00b1233500322333535006003220020020013535004001220011221233001003002120011221233001003002120012221233300100400300220012253353003333573466e3cd4c01800888008d4c018004880080140104ccd5cd19b8735300600222001353006001220010050041004122002122001200122123300100300220011123230010012233003300200200133322233322233322233223300230074891c4ea976fd940616cba7c01514e9bb4026cff5a087987d5595f3ad0aa500500a221233001003002200121223002003222122333001005004003200121223002003212230010032001121223002003112200112001332233002488120686106f51262efb810d99311d3bbe478ba5abb92b5be2e1f9488d56622caf6f400480108848cc00400c0088004cc88cc88ccc00922010a46696f6e61204c69736100488120f8bbaa59790d202a879995c38e53d59883c520ae335b95fca9ee2cd24a874958003300448920686106f51262efb810d99311d3bbe478ba5abb92b5be2e1f9488d56622caf6f4004801088848ccc00401000c00880048848cc00400c00880050481d8799fd8799fd8799f4a46696f6e61204c697361ff5820f8bbaa59790d202a879995c38e53d59883c520ae335b95fca9ee2cd24a874958d8799fd8799f5820686106f51262efb810d99311d3bbe478ba5abb92b5be2e1f9488d56622caf6f4ff02ffffd8799f010affd8799f581ca096d51da85c3eaabe2718be7b59f51291979935ad77b8deb4622fa3ffd8799f581ca096d51da85c3eaabe2718be7b59f51291979935ad77b8deb4622fa3ffd8799f05ffff0581840100008219a7f81a00c2e56df5f6"
    [] []

test :: IO ()
test = requestBalance (WbeCfg "") 
          "01f9f1dda617eb8bff71468c702afceee5b1ccbf"
          testRequest